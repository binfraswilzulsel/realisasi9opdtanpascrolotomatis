<!DOCTYPE html>
<html lang="id">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>Dashboard OPD â€” Realisasi Keuangan & Fisik</title>
Â  
Â  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
Â  <style>
Â  Â  :root {
Â  Â  Â  --bg: #0740aa;
Â  Â  Â  --card: #ffffff;
Â  Â  Â  --muted: #6b7280;
Â  Â  Â  --accent-green: #07AA1F;
Â  Â  Â  --accent-blue: #1149b8;
Â  Â  Â  --accent-pink: #AA0792;
Â  Â  Â  --radius: 18px;
Â  Â  Â  --pad: 14px;
Â  Â  }

Â  Â  html,body{height:100%}
Â  Â  body {
Â  Â  Â  margin: 0;
Â  Â  Â  background: var(--bg);
Â  Â  Â  font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
Â  Â  Â  color: #0740aa;
Â  Â  Â  padding: 20px;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  .container {
Â  Â  Â  display: flex;
Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  gap: 20px;
Â  Â  Â  justify-content: center;
Â  Â  Â  margin: 0 auto;
Â  Â  Â  padding-bottom: 1px;
Â  Â  }

Â  Â  .opd-card {
Â  Â  Â  background: var(--card);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: var(--pad);
Â  Â  Â  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
Â  Â  Â  position: relative;
Â  Â  Â  overflow: visible;
Â  Â  Â  width: calc(50% - 10px);
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  .emoji-wrap {
Â  Â  Â  flex: 0 0 90px;
Â  Â  Â  border-radius: 12px;
Â  Â  Â  background: linear-gradient(180deg,#fff8,#fff0);
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  font-size: 60px;
Â  Â  }

Â  Â  .opd-header {
Â  Â  Â  display: flex;
Â  Â  Â  gap: 10px;
Â  Â  Â  align-items: center;
Â  Â  Â  margin-top: 5px;
Â  Â  }

Â  Â  .opd-body .total-anggaran {
Â  Â  Â  background-color: var(--accent-blue);
Â  Â  Â  color: white;
Â  Â  Â  font-weight: 700;
Â  Â  Â  font-size: 16px;
Â  Â  Â  padding: 6px 6px;
Â  Â  Â  border-radius: 8px;
Â  Â  Â  margin-top: 8px;
Â  Â  Â  text-align: center;
Â  Â  Â  width: 100%;
Â  Â  Â  max-width: 85%;
Â  Â  Â  box-sizing: border-box;
Â  Â  }

Â  Â  .opd-body { flex: 1; }
Â  Â  .opd-title { font-weight: 800; font-size: 24px; color: #0b4aa2; margin: 0; line-height: 1; }
Â  Â  .sub { color: var(--muted); margin-top: 6px; font-size: 14px; }

Â  Â  /* Toggle Button tidak ada lagi */
Â  Â  
Â  Â  .monthly {
Â  Â  Â  background: #40AA07;
Â  Â  Â  border-radius: 16px; 
Â  Â  Â  padding: 8px; 
Â  Â  Â  text-align: center;
Â  Â  Â  margin-top: 10px;
Â  Â  Â  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
Â  Â  Â  width: 92%; 
Â  Â  Â  margin: 10px auto;
Â  Â  }

Â  Â  .monthly h3 { 
Â  Â  Â  margin: 0; 
Â  Â  Â  font-size: 12px; 
Â  Â  Â  color: #ffffff; }
Â  Â  
Â  Â  .monthly .amount { 
Â  Â  Â  margin-top: 0; 
Â  Â  Â  font-size: 22px; 
Â  Â  Â  font-weight: bold; 
Â  Â  Â  color: #ffffff; }

Â  Â  .chart-card {
Â  Â  Â  background: var(--card);
Â  Â  Â  border-radius: 20px;
Â  Â  Â  padding: 12px;
Â  Â  Â  margin-top: 14px;
Â  Â  Â  outline: #AA0792 solid 3px;
Â  Â  Â  width: 89%;
Â  Â  Â  margin: 14px auto;

      /* Chart Card sekarang SELALU tampil */
Â  Â  }

Â  Â  .chart-title { font-weight: bold; text-align: center; margin-bottom: 8px; font-size: 14px; }
Â  Â  .legend { display: flex; gap: 12px; justify-content: center; margin-bottom: 10px; font-size: 13px; color: var(--muted); }
Â  Â  .legend .item { display: flex; gap: 8px; align-items: center; }
Â  Â  .dot { width: 18px; height: 10px; border-radius: 6px; display: inline-block; }

Â  Â  .progress-row { margin-top: 8px; font-size: 14px; color: #111; }
Â  Â  .progress-label { color: var(--muted); font-size: 13px; }
Â  Â  .progress-bar { background: #e6e6e6; border-radius: 999px; height: 22px; overflow: hidden; display: flex; align-items: center; padding: 3px; }
Â  Â  .progress-fill {
Â  Â  Â  height: 100%;
Â  Â  Â  border-radius: 999px;
Â  Â  Â  display: flex;
Â  Â  Â  align-items: center;
Â  Â  Â  justify-content: center;
Â  Â  Â  color: white;
Â  Â  Â  font-weight: 800;
Â  Â  Â  min-width: 40px;
Â  Â  Â  transition: width 600ms ease;
Â  Â  }

Â  Â  .pie-wrapper { position: relative; padding: 10px; }
Â  Â  .pie-canvas { width: 100% !important; max-width: 400px; margin: 0 auto; }

Â  Â  @media (max-width: 768px) {
Â  Â  Â  .opd-card { width: 100%; }
Â  Â  Â  .pie-canvas { max-width: 350px; }
Â  Â  }

Â  Â  @media (max-width: 420px) {
Â  Â  Â  .opd-card { padding: 12px; }
Â  Â  Â  .big-amount { font-size: 18px; }
Â  Â  Â  .monthly .amount { font-size: 22px; }
Â  Â  Â  .pie-canvas {
Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  }
Â  Â  }

Â  Â  .hingga-bg {
Â  Â  Â  background-color: #AA0792; 
Â  Â  Â  padding: 1px 4px; 
Â  Â  Â  border-radius: 5px; 
Â  Â  Â  font-weight: bold;
Â  Â  Â  color: #ffffff; 
Â  Â  }

Â  Â  footer { text-align: center; color: white; padding: 25px; font-size: 11px; }
Â  </style>
</head>

<body>
Â  <div class="container" id="containerOPD"></div>

Â  <script>
    // ####################################################################
    // GANTI URL INI dengan URL Apps Script Data Utama Anda
    // ####################################################################
Â  Â  const APPSCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyYScBrl0u_uouNkBg1TI38ZyuJRK4VxlxC-_S1LiCsgrxVzS5jNM1TPlTngtOao62vCQ/exec'; 
	Â Â 
	Â  const formatRupiah = (n) => new Intl.NumberFormat('id-ID').format(n);

Â  Â  function getUrlParameter(name) {
Â  Â  Â  Â  name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
Â  Â  Â  Â  const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
Â  Â  Â  Â  const results = regex.exec(location.search);
Â  Â  Â  Â  return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
Â  Â  }

Â  Â  async function fetchOPDData() {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const response = await fetch(APPSCRIPT_URL);
Â  Â  Â  Â  Â  Â  return await response.json(); 
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  console.error("Gagal mengambil data dari Apps Script:", error);
Â  Â  Â  Â  Â  Â  return []; 
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // Plugin Chart.js untuk menampilkan nilai di tengah pie chart
Â  Â  const pieLabelPlugin = {
Â  Â  Â  Â  id: 'pieLabelPlugin',
Â  Â  Â  Â  afterDraw(chart) {
Â  Â  Â  Â  Â  Â  const { ctx } = chart;
Â  Â  Â  Â  Â  Â  const meta = chart.getDatasetMeta(0);
Â  Â  Â  Â  Â  Â  const data = chart.data.datasets[0].data;
Â  Â  Â  Â  Â  Â  ctx.save();
Â  Â  Â  Â  Â  Â  ctx.font = 'bold 11px Inter';
Â  Â  Â  Â  Â  Â  ctx.fillStyle = '#fff';
Â  Â  Â  Â  Â  Â  ctx.textAlign = 'center';
Â  Â  Â  Â  Â  Â  ctx.textBaseline = 'middle';
Â  Â  Â  Â  Â  Â  meta.data.forEach((arc, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  const pos = arc.tooltipPosition();
Â  Â  Â  Â  Â  Â  Â  Â  ctx.fillText('Rp. ' + formatRupiah(data[i]), pos.x, pos.y);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  ctx.restore();
Â  Â  Â  Â  }
Â  Â  };


Â  Â  function createOPDCard(opd, idx) {
Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  card.className = 'opd-card';
Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="opd-header">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="emoji-wrap">${opd.emoji}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="opd-body">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="opd-title">${opd.opdName}</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="sub">Total Anggaran :</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="big-amount total-anggaran">Rp. ${formatRupiah(opd.totalBudget)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

            Â  Â  Â  Â  Â  Â  <div class="monthly">
Â  Â  Â  Â  Â  Â  Â  Â  <h3>REALISASI BULAN OKTOBER</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="amount">Rp. ${formatRupiah(opd.realisasiBulanOktober)}</div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="chart-card">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="chart-title">TOTAL REALISASI <span class="hingga-bg">HINGGA</span> OKTOBER</div>
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  <div class="legend">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="dot" style="background:var(--accent-green)"></span> Realisasi</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="dot" style="background:var(--accent-blue)"></span> Sisa Dana</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pie-wrapper"><canvas id="pie${idx}" class="pie-canvas" width="400" height="400"></canvas></div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-label">Realisasi Keuangan (%)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar"><div class="progress-fill" id="finance${idx}" style="width:0;background:var(--accent-green)">0%</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-row">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-label">Realisasi Fisik (%)</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="progress-bar"><div class="progress-fill" id="physical${idx}" style="width:0;background:var(--accent-pink)">0%</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  return card;
Â  Â  }

Â  Â  function setProgress(el, percent) {
Â  Â  Â  Â  const val = Math.max(0, Math.min(100, percent)); 
Â  Â  Â  Â  el.style.width = val + '%';
Â  Â  Â  Â  el.textContent = val.toFixed(2).replace(/\.00$/, '') + '%'; 
Â  Â  }

function renderAllOPD(dataOPD) {
Â  Â  Â  Â  const container = document.getElementById('containerOPD');
Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  dataOPD.forEach((opd, idx) => {
Â  Â  Â  Â  Â  Â  const card = createOPDCard(opd, idx);
Â  Â  Â  Â  Â  Â  container.appendChild(card);

Â  Â  Â  Â  Â  Â  // LOGIKA PERHITUNGAN YANG BENAR
Â  Â  Â  Â  Â  Â  const total = opd.realisasiTotal; 
Â  Â  Â  Â  Â  Â  const sisa = opd.totalBudget - total;
Â  Â  Â  Â  Â  Â  const persenKeuangan = (total / (opd.totalBudget || 1)) * 100;

Â  Â  Â  Â  Â  Â  const ctx = document.getElementById(`pie${idx}`).getContext('2d');
Â  Â  Â  Â  Â  Â  new Chart(ctx, {
Â  Â  Â  Â  Â  Â  Â  Â  type: 'pie',
Â  Â  Â  Â  Â  Â  Â  Â  data: { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  labels: ['Realisasi', 'Sisa Dana'], 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  datasets: [{ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data: [total, sisa], 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  backgroundColor: ['#07AA1F', '#0740AA'],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderColor: '#fff', 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  borderWidth: 4 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }] 
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  options: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  responsive: true, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  maintainAspectRatio: false, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  plugins: { legend: { display: false }, tooltip: { enabled: false } } 
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  plugins: [pieLabelPlugin]
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Mengisi Progress Bar Keuangan dan Fisik
Â  Â  Â  Â  Â  Â  setProgress(document.getElementById(`finance${idx}`), persenKeuangan);
Â  Â  Â  Â  Â  Â  setProgress(document.getElementById(`physical${idx}`), opd.percentPhysical);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // =====================
Â  Â  // INISIALISASI DASHBOARD
Â  Â  // =====================
Â  Â  async function initDashboard() {
Â  Â  Â  Â  let selectedOpdId = getUrlParameter('opd');
Â  Â  Â  Â  if (!selectedOpdId && window.location.hash) {
Â  Â  Â  Â  Â  Â  selectedOpdId = window.location.hash.substring(1);
Â  Â  Â  Â  }

Â  Â  Â  Â  const allDataOPD = await fetchOPDData();
Â  Â  Â  Â  renderAllOPD(allDataOPD);

        // Scroll ke kartu yang sesuai (jika ada)
Â  Â  Â  Â  if (selectedOpdId) {
Â  Â  Â  Â  Â  Â  const normalize = str => str.toLowerCase().replace(/[^a-z0-9]/g, '');
Â  Â  Â  Â  Â  Â  const targetId = normalize(selectedOpdId);

Â  Â  Â  Â  Â  Â  const targetCard = Array.from(document.querySelectorAll('.opd-card')).find(el => {
Â  Â  Â  Â  Â  Â  Â  Â  const titleText = el.querySelector('.opd-title')?.textContent || '';
Â  Â  Â  Â  Â  Â  Â  Â  return normalize(titleText).includes(targetId);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (targetCard) {
Â  Â  Â  Â  Â  Â  Â  Â  targetCard.setAttribute('id', targetId);

Â  Â  Â  Â  Â  Â  Â  Â  // Beri jeda waktu agar grafik sempat di-render sepenuhnya
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const offsetTop = targetCard.getBoundingClientRect().top + window.scrollY - 25;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.scrollTo({ top: offsetTop, behavior: 'smooth' });
Â  Â  Â  Â  Â  Â  Â  Â  }, 400);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  }

Â  Â  initDashboard();
</script>

Â  <footer>
Â  Â  Data Extract â†’ https://sulselprov.e-planning.id <br>
Â  Â  31 Oktober 2025 | 16.30 WITA | &copy; Copyright by @zuwlend
Â  </footer>

<div style="
Â  position: fixed;
Â  bottom: 20px;
Â  left: 20px;
Â  z-index: 999;
Â  text-align: center;
Â  font-family: Arial, sans-serif;
Â  cursor: pointer;
Â  user-select: none;">
Â  <a href="index.html" style="font-size: 20px; font-weight: bold; text-decoration: none; display: block; line-height: 40px;">ðŸ‘ˆ</a>
</div>

</body>
</html>
